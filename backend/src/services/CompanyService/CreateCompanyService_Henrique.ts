import * as Yup from "yup";
import AppError from "../../errors/AppError";
import Company from "../../models/Company";
import User from "../../models/User";
import Setting from "../../models/Setting";

interface CompanyData {
    name: string;
    phone?: string;
    email?: string;
    password?: string;
    status?: boolean;
    planId?: number;
    campaignsEnabled?: boolean;
    dueDate?: string;
    recurrence?: string;
}

const CreateCompanyService = async (
    companyData: CompanyData
): Promise<Company> => {
    const {
        name,
        phone,
        email,
        status,
        planId,
        password,
        campaignsEnabled,
        dueDate,
        recurrence
    } = companyData;
    console.log("ðŸš€ Console Log : companyData.password", companyData.password);

    const companySchema = Yup.object().shape({
        name: Yup.string()
            .min(2, "ERR_COMPANY_INVALID_NAME")
            .required("ERR_COMPANY_INVALID_NAME")
            .test(
                "Check-unique-name",
                "ERR_COMPANY_NAME_ALREADY_EXISTS",
                async value => {
                    if (value) {
                        const companyWithSameName = await Company.findOne({
                            where: { name: value }
                        });

                        return !companyWithSameName;
                    }
                    return false;
                }
            )
    });

    try {
        await companySchema.validate({ name });
    } catch (err: any) {
        throw new AppError(err.message);
    }

    const company = await Company.create({
        name,
        phone,
        email,
        status,
        planId,
        dueDate,
        recurrence
    });

    const user = await User.create({
        name: company.name,
        email: company.email,
        password: companyData.password,
        profile: "admin",
        companyId: company.id
    });

    if (companyData.campaignsEnabled !== undefined) {
        const [setting, created] = await Setting.findOrCreate({
            where: {
                companyId: company.id,
                key: "campaignsEnabled"
            },
            defaults: {
                companyId: company.id,
                key: "campaignsEnabled",
                value: `${campaignsEnabled}`
            }
        });
        if (!created) {
            await setting.update({ value: `${campaignsEnabled}` });
        }
    }

    return company;
};

export default CreateCompanyService;